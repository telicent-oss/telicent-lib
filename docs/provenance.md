# Provenance and Audit

## Heartbeats

When a telicent-lib component is run, by default, it will automatically send a regular heartbeat messages to the provenance topic
using a `KafkaSink`.

The provenance topic can be specified with the environment variable `HEART_BEAT_PROVENANCE_TOPIC`. By default, heartbeats are 
written to the topic `provenance.live`.

Heartbeats are sent at a specified interval, by default every 15 seconds. This frequency can be configured per action and is detailed below.

### Message Format

**Message**

| Status           | Type         | Definition                                                                                                                             |
|------------------|--------------|----------------------------------------------------------------------------------------------------------------------------------------|
| id               | string       | An ID for the component, set by the user or generated by the component itself. Should be the same ID for all instances of a component. |
| instance_id      | string       | An ID for a specific instance of a component. By default UUID but could be overriden per instance if required.                         |
| name             | string       | The name of the component as defined by the user.                                                                                      |
| timestamp        | XSD datetime | Timestamp set by the component when sending the message.                                                                               |
| component_type   | string       | The type of component, e.g. adaptor, mapper, or projector.                                                                             | 
| reporting_period | integer      | The reporting period in seconds.                                                                                                       | 
| input            | JSON object  | Object describing the input of the component.                                                                                          | 
| output           | JSON object  | Object describing the output of the component.                                                                                         |
| status           | string       | The current status of the component, or REGISTERED if the component has just initialised.                                              | 

**Input / Output Object**

| Status | Type         | Definition                                                                  |
|--------|--------------|-----------------------------------------------------------------------------|
| name   | string       | The name of the input or output, e.g. the topic name, AWS bucket, database. |
| type   | string       | The type of input or output, e.g. topic, database, bucket.                  |

**Statuses**

| Status     | Definition                                                                      |
|------------|---------------------------------------------------------------------------------|
| STARTED    | A component has started and is ready to process messages.                       |
| RUNNING    | A component is running and has processed records. This is an on-going ping.     |
| COMPLETED  | A component has a fixed number of records and has processed all records.        |
| TERMINATED | A component has terminated, either through an interrupt, signal or due to error. |


### Disable the Reporter

```python
from telicent_lib.mapper import Mapper

mapper = Mapper(
    source=my_source, target=my_sink, map_function=map_func, has_reporter=False
)
mapper.run()
```

### Manually set the Reporter's sink

```python
from telicent_lib.mapper import Mapper
from telicent_lib.sinks.listSink import ListSink

reporter_sink = ListSink()
mapper = Mapper(
    source=my_source, target=my_sink, map_function=map_func, reporter_sink=reporter_sink
)
mapper.run()
```

### Changing the Reporting Frequency

```python
from telicent_lib.mapper import Mapper

mapper = Mapper(
    source=my_source, target=my_sink, map_function=map_func
)
mapper.reporter.heartbeat_time = 60  # set to every 60 seconds
mapper.run()
```


## Audit Headers

telicent-lib automatically applies headers to each record written by an adapter or a mapper. These records provide an audit that gives
each record a unique ID, which component wrote the record, and in the case of a mapper, the unique ID of the source record.

| Header             | Usage                                                                                                                            |
|--------------------|----------------------------------------------------------------------------------------------------------------------------------|
| `Request-Id`       | Unique ID for the request composed of the topic and a UUID                                                                       |
| `Exec-Path`        | ID of the component processing the record                                                                                        |
| `Input-Request-Id` | Input record's request ID, where present. Header may be repeated if there are multiple input requests, e.g. when merging records |
